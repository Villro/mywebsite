<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tambola Ticket üéüÔ∏è</title>
<style>
  body {
    font-family:"Segoe UI",Arial,sans-serif;
    background:#101820;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
    margin:0;
  }
  h2 {
    color:#ffcc00;
    margin:12px 0;
  }
  .ticket {
    display:grid;
    grid-template-rows:repeat(3,1fr);
    gap:8px;
    background:#1a2533;
    padding:14px;
    border-radius:12px;
    box-shadow:0 6px 28px rgba(0,0,0,.5);
    width:520px;
    max-width:96vw;
  }
  .row {
    display:grid;
    grid-template-columns:repeat(9,1fr);
    gap:6px;
  }
  .cell {
    aspect-ratio:1/1; /* ‚úÖ perfect square everywhere */
    display:flex;
    align-items:center;
    justify-content:center;
    background:#f5f5f5;
    color:#222;
    font-weight:700;
    border-radius:8px;
    cursor:pointer;
    user-select:none;
    font-size:18px;
    transition:all .14s ease;
  }
  .cell.empty {
    background:transparent;
    border:1px dashed rgba(255,255,255,.08);
    cursor:default;
    color:#bbb;
    font-weight:600;
  }
  .cell.marked {
    background:#d62828;
    color:#fff;
  }
  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:12px;
    align-items:center;
    justify-content:center;
  }
  .btn {
    background:#ffcc00;
    border:none;
    padding:10px 14px;
    border-radius:8px;
    color:#000;
    font-weight:700;
    cursor:pointer;
  }
  .timestamp {
    color:#cfcfcf;
    margin-top:8px;
    font-size:13px;
    text-align:center;
  }
  @media (max-width:560px) {
    .cell { font-size:15px; }
  }
</style>
</head>
<body>

<h2>Your Tambola Ticket üéüÔ∏è</h2>
<div class="ticket" id="ticket"></div>

<div class="controls">
  <button class="btn" id="newBtn">üé≤ New Ticket</button>
  <button class="btn" id="saveBtn">üíæ Save</button>
  <button class="btn" id="clearBtn">üßπ Clear Marks</button>
</div>

<div class="timestamp" id="timestamp"></div>

<script>
const ROWS=3,COLS=9,STORAGE_KEY='tambola_ticket_v2';
const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const shuffle=arr=>arr.slice().sort(()=>Math.random()-0.5);

function makeColumnCounts(){
  const counts=Array(COLS).fill(1); let remaining=15-COLS;
  while(remaining>0){const i=Math.floor(Math.random()*COLS);if(counts[i]<3){counts[i]++;remaining--;}}
  return counts;
}
function assignRowsToColumns(colCounts){
  const assign=Array.from({length:COLS},()=>[]); const rowSlots=[5,5,5];
  const order=[...Array(COLS).keys()].sort((a,b)=>colCounts[b]-colCounts[a]||Math.random()-0.5);
  for(const c of order){const k=colCounts[c];const pickable=[0,1,2].sort((a,b)=>rowSlots[b]-rowSlots[a]||Math.random()-0.5);const chosen=pickable.slice(0,k);chosen.forEach(r=>{assign[c].push(r);rowSlots[r]--;});}
  return assign;
}

function buildGrid(){
  const colCounts=makeColumnCounts();
  const rowsByCol=assignRowsToColumns(colCounts);
  const columnsNumbers=[];
  for(let c=0;c<COLS;c++){
    const start=c*10+1,end=(c===8)?90:(c+1)*10;
    const all=Array.from({length:end-start+1},(_,i)=>start+i);
    const pickCount=rowsByCol[c].length;
    const chosen=shuffle(all).slice(0,pickCount).sort((a,b)=>a-b);
    columnsNumbers.push(chosen);
  }
  const grid=Array.from({length:ROWS},()=>Array(COLS).fill(null));
  for(let c=0;c<COLS;c++){
    const rows=rowsByCol[c].slice().sort((a,b)=>a-b);
    const nums=columnsNumbers[c].slice().sort((a,b)=>a-b);
    for(let i=0;i<Math.min(rows.length,nums.length);i++) grid[rows[i]][c]=nums[i];
  }
  const totals=grid.flat().filter(x=>x!==null).length;
  if(totals!==15) return buildGrid();
  return grid;
}

function renderTicket(grid,marked=[]){
  const container=document.getElementById('ticket');
  container.innerHTML='';
  for(let r=0;r<ROWS;r++){
    const row=document.createElement('div');row.className='row';
    for(let c=0;c<COLS;c++){
      const cell=document.createElement('div');cell.className='cell';
      cell.dataset.row=r;cell.dataset.col=c;
      const val=grid[r][c];
      if(val===null){cell.classList.add('empty');}
      else{
        cell.textContent=val;
        const key=`${r}-${c}`;
        if(marked.includes(key))cell.classList.add('marked');
        cell.onclick=()=>{cell.classList.toggle('marked');persistState(grid);};
      }
      row.appendChild(cell);
    }
    container.appendChild(row);
  }
}
function persistState(grid){
  const marked=Array.from(document.querySelectorAll('.cell.marked')).map(n=>`${n.dataset.row}-${n.dataset.col}`);
  const time=localStorage.getItem('ticket_created_time')||new Date().toLocaleString();
  const data={grid,marked,time};
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  localStorage.setItem('ticket_created_time',time);
  document.getElementById('timestamp').textContent=`Created: ${time}`;
}
function createAndSaveTicket(){
  const grid=buildGrid(),time=new Date().toLocaleString();
  const data={grid,marked:[],time};
  localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  localStorage.setItem('ticket_created_time',time);
  renderTicket(grid,[]);
  document.getElementById('timestamp').textContent=`Created: ${time}`;
}
function loadTicket(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw)return false;
  try{
    const data=JSON.parse(raw);
    if(!data||!Array.isArray(data.grid))return false;
    renderTicket(data.grid,data.marked||[]);
    document.getElementById('timestamp').textContent=`Created: ${data.time||''}`;
    return true;
  }catch(e){console.error(e);return false;}
}

document.getElementById('newBtn').onclick=()=>{if(confirm('Generate a NEW ticket? This will replace saved ticket and marks.'))createAndSaveTicket();};
document.getElementById('saveBtn').onclick=()=>{
  const grid=[...Array(ROWS)].map(()=>Array(COLS).fill(null));
  document.querySelectorAll('.cell').forEach(el=>{
    const r=+el.dataset.row,c=+el.dataset.col;
    grid[r][c]=el.classList.contains('empty')?null:(el.textContent?+el.textContent:null);
  });
  persistState(grid);
  alert('Saved!');
};
document.getElementById('clearBtn').onclick=()=>{
  document.querySelectorAll('.cell.marked').forEach(el=>el.classList.remove('marked'));
  const raw=localStorage.getItem(STORAGE_KEY);
  if(raw){
    const data=JSON.parse(raw);
    data.marked=[];
    localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
  }
  alert('All marks cleared!');
};

if(!loadTicket())createAndSaveTicket();
</script>
</body>
</html>
